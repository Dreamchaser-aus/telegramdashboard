<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>用户管理后台</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { padding: 20px; }
  .stats { background-color: #d1ecf1; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
  .table thead th { background-color: #212529; color: white; }
  .btn-save { background-color: #198754; color: white; }
  .btn-delete { background-color: #dc3545; color: white; }
  .btn-record { background-color: #0dcaf0; color: white; }
</style>
<script>
async function updateBlockStatus(userId, selectElem) {
  const isBlocked = selectElem.value === '是' ? 1 : 0;
  try {
    const res = await fetch('/update_block_status', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({user_id: userId, is_blocked: isBlocked})
    });
    if (!res.ok) alert('更新失败');
  } catch(e) {
    alert('请求异常');
  }
}

async function saveUser(userId, btn) {
  const row = btn.closest('tr');
  const points = row.querySelector('.points-input').value;
  const plays = row.querySelector('.plays-input').value;
  const blockSelect = row.querySelector('.block-select');
  const isBlocked = blockSelect.value === '是' ? 1 : 0;

  const formData = new FormData();
  formData.append('user_id', userId);
  formData.append('points', points);
  formData.append('plays', plays);
  formData.append('is_blocked', isBlocked);

  try {
    const res = await fetch('/update_user', {
      method: 'POST',
      body: formData
    });
    if (!res.ok) alert('保存失败');
    else alert('保存成功');
  } catch(e) {
    alert('请求异常');
  }
}

async function deleteUser(userId, btn) {
  if (!confirm('确认删除该用户？此操作不可恢复！')) return;
  const formData = new FormData();
  formData.append('user_id', userId);
  try {
    const res = await fetch('/delete_user', {
      method: 'POST',
      body: formData
    });
    if (!res.ok) alert('删除失败');
    else {
      alert('删除成功');
      btn.closest('tr').remove();
    }
  } catch(e) {
    alert('请求异常');
  }
}
</script>
</head>
<body>

<div class="container">

  <form method="get" class="mb-3 d-flex gap-2">
    <input type="text" name="keyword" placeholder="模糊搜索用户名或手机号" class="form-control" value="{{ keyword }}">
    <button type="submit" class="btn btn-primary">搜索</button>
    <a href="/rank_data" class="btn btn-success" target="_blank">查看今日排行榜</a>
  </form>

  <div class="stats">
    总用户数: {{ stats.total_users }} | 已授权手机号: {{ stats.authorized_users }} | 已封禁用户: {{ stats.blocked_users }} | 总积分: {{ stats.total_points }}
  </div>

  <table class="table table-bordered table-hover align-middle">
    <thead>
      <tr>
        <th>用户ID</th>
        <th>用户名</th>
        <th>手机号</th>
        <th>积分</th>
        <th>今日游戏次数</th>
        <th>邀请人</th>
        <th>封禁状态</th>
        <th>注册时间</th>
        <th>最后游戏时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user[0] }}</td> <!-- user_id -->
        <td>{{ user[3] }}</td> <!-- username -->
        <td>{{ user[4] if user[4] else '未授权' }}</td> <!-- phone -->
        <td><input type="number" class="form-control points-input" value="{{ user[5] }}"></td> <!-- points -->
        <td><input type="number" class="form-control plays-input" value="{{ user[6] }}"></td> <!-- plays -->
        <td>{{ user[12] if user[12] else '无' }}</td> <!-- inviter_username -->
        <td>
          <select class="form-select block-select" onchange="updateBlockStatus('{{ user[0] }}', this)">
            <option value="否" {% if not user[11] %}selected{% endif %}>否</option>
            <option value="是" {% if user[11] %}selected{% endif %}>是</option>
          </select>
        </td>
        <td>{{ user[7] }}</td> <!-- created_at -->
        <td>{{ user[8] if user[8] else '无' }}</td> <!-- last_play -->
        <td>
          <button type="button" class="btn btn-record btn-sm" onclick="window.open('/game_history?user_id={{ user[0] }}', '_blank')">查看游戏记录</button>
          <button type="button" class="btn btn-save btn-sm" onclick="saveUser('{{ user[0] }}', this)">保存</button>
          <button type="button" class="btn btn-delete btn-sm" onclick="deleteUser('{{ user[0] }}', this)">删除用户</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- 分页 -->
  <nav aria-label="分页">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if stats.page == 1 %}disabled{% endif %}">
        <a class="page-link" href="?page={{ stats.page - 1 }}&keyword={{ keyword }}">上一页</a>
      </li>
      <li class="page-item disabled">
        <a class="page-link" href="#">{{ stats.page }} / {{ stats.total_pages }}</a>
      </li>
      <li class="page-item {% if stats.page == stats.total_pages %}disabled{% endif %}">
        <a class="page-link" href="?page={{ stats.page + 1 }}&keyword={{ keyword }}">下一页</a>
      </li>
    </ul>
  </nav>

</div>

</body>
</html>
